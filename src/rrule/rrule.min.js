(function(E,C){"object"===typeof module&&module.exports?module.exports=C():"function"===typeof define&&define.amd?define([],C):(E.RRule=C(E),E.RRuleSet=E.RRule.RRuleSet,E.rrulestr=E.RRule.rrulestr)})("object"===typeof window?window:this,function(E){function C(){if(!C._nlp)if(E&&E._getRRuleNLP)C._nlp=E._getRRuleNLP(h);else if("function"===typeof require)C._nlp=require("./nlp")(h);else throw Error("You need to include rrule/nlp.js for fromText/toText to work.");return C._nlp}var p={MONTH_DAYS:[31,28,
31,30,31,30,31,31,30,31,30,31],ONE_DAY:864E5,MAXYEAR:9999,ORDINAL_BASE:new Date(1970,0,1),PY_WEEKDAYS:[6,0,1,2,3,4,5],getYearDay:function(a){var b=new Date(a.getFullYear(),a.getMonth(),a.getDate());return Math.ceil((b-new Date(a.getFullYear(),0,1))/p.ONE_DAY)+1},isLeapYear:function(a){a instanceof Date&&(a=a.getFullYear());return 0===a%4&&0!==a%100||0===a%400},tzOffset:function(a){return 6E4*a.getTimezoneOffset()},daysBetween:function(a,b){var c=a.getTime()-p.tzOffset(a),e=b.getTime()-p.tzOffset(b),
c=Math.abs(c-e);return Math.round(c/p.ONE_DAY)},toOrdinal:function(a){return p.daysBetween(a,p.ORDINAL_BASE)},fromOrdinal:function(a){a*=p.ONE_DAY;return new Date(p.ORDINAL_BASE.getTime()-p.tzOffset(p.ORDINAL_BASE)+a+p.tzOffset(new Date(a)))},monthRange:function(a,b){var c=new Date(a,b,1);return[p.getWeekday(c),p.getMonthDays(c)]},getMonthDays:function(a){var b=a.getMonth();return 1===b&&p.isLeapYear(a)?29:p.MONTH_DAYS[b]},getWeekday:function(a){return p.PY_WEEKDAYS[a.getDay()]},combine:function(a,
b){b=b||a;return new Date(a.getFullYear(),a.getMonth(),a.getDate(),b.getHours(),b.getMinutes(),b.getSeconds(),b.getMilliseconds())},clone:function(a){return new Date(a.getTime())},cloneDates:function(a){for(var b=[],c=0;c<a.length;c++)b.push(p.clone(a[c]));return b},sort:function(a){a.sort(function(a,c){return a.getTime()-c.getTime()})},timeToUntilString:function(a){a=new Date(a);for(var b=[a.getUTCFullYear(),a.getUTCMonth()+1,a.getUTCDate(),"T",a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),
"Z"],c=0;c<b.length;c++)a=b[c],!/[TZ]/.test(a)&&10>a&&(b[c]="0"+String(a));return b.join("")},untilStringToDate:function(a){var b=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z)?$/.exec(a);if(!b)throw Error("Invalid UNTIL value: "+a);return new Date(Date.UTC(b[1],b[2]-1,b[3],b[5]||0,b[6]||0,b[7]||0))},Time:function(a,b,c,e){this.hour=a;this.minute=b;this.second=c;this.millisecond=e||0}};p.Time.prototype={constructor:p.Time,getHours:function(){return this.hour},getMinutes:function(){return this.minute},
getSeconds:function(){return this.second},getMilliseconds:function(){return this.millisecond},getTime:function(){return 1E3*(3600*this.hour+60*this.minute+this.second)+this.millisecond}};var G=function(a,b){1===arguments.length&&(b=a,a=0);for(var c=[],e=a;e<b;e++)c.push(e);return c},q=function(a,b){var c=0,e=[];if(a instanceof Array)for(;c<b;c++)e[c]=[].concat(a);else for(;c<b;c++)e[c]=a;return e},F=function(a,b){var c=a%b;return 0>c*b?c+b:c},S=function(a,b){return{div:Math.floor(a/b),mod:F(a,b)}},
v=function(a){return a instanceof Array&&0===a.length?!1:Boolean(a)},r=function(a,b){return-1!==a.indexOf(b)},ea=[].concat(q(1,31),q(2,28),q(3,31),q(4,30),q(5,31),q(6,30),q(7,31),q(8,31),q(9,30),q(10,31),q(11,30),q(12,31),q(1,7)),fa=[].concat(q(1,31),q(2,29),q(3,31),q(4,30),q(5,31),q(6,30),q(7,31),q(8,31),q(9,30),q(10,31),q(11,30),q(12,31),q(1,7)),Q=G(1,29),T=G(1,30),B=G(1,31),n=G(1,32),ga=[].concat(n,T,n,B,n,B,n,n,B,n,B,n,n.slice(0,7)),ha=[].concat(n,Q,n,B,n,B,n,n,B,n,B,n,n.slice(0,7)),Q=G(-28,0),
T=G(-29,0),B=G(-30,0),n=G(-31,0),ia=[].concat(n,T,n,B,n,B,n,n,B,n,B,n,n.slice(0,7)),ja=[].concat(n,Q,n,B,n,B,n,n,B,n,B,n,n.slice(0,7)),ka=[0,31,60,91,121,152,182,213,244,274,305,335,366],la=[0,31,59,90,120,151,181,212,243,273,304,334,365],ba=function(){for(var a=[],b=0;55>b;b++)a=a.concat(G(7));return a}(),D=function(a,b){if(0===b)throw Error("Can't create weekday with n \x3d\x3d 0");this.weekday=a;this.n=b};D.prototype={constructor:D,nth:function(a){return this.n===a?this:new D(this.weekday,a)},
equals:function(a){return this.weekday===a.weekday&&this.n===a.n},toString:function(){var a="MO TU WE TH FR SA SU".split(" ")[this.weekday];this.n&&(a=(0<this.n?"+":"")+String(this.n)+a);return a},getJsWeekday:function(){return 6===this.weekday?0:this.weekday+1}};var h=function(a,b){a=a||{};this._string=null;this._cache=b?null:{all:!1,before:[],after:[],between:[]};this.origOptions={};var c=[],e=Object.keys(a),f=Object.keys(h.DEFAULT_OPTIONS);e.forEach(function(b){this.origOptions[b]=a[b];r(f,b)||
c.push(b)},this);if(c.length)throw Error("Invalid options: "+c.join(", "));if(!h.FREQUENCIES[a.freq]&&null===a.byeaster)throw Error("Invalid frequency: "+String(a.freq));f.forEach(function(b){r(e,b)||(a[b]=h.DEFAULT_OPTIONS[b])});var d=this.options=a;null!==d.byeaster&&(d.freq=h.YEARLY);d.dtstart||(d.dtstart=new Date);var g=d.dtstart.getTime()%1E3;null===d.wkst?d.wkst=h.MO.weekday:"number"!==typeof d.wkst&&(d.wkst=d.wkst.weekday);if(null!==d.bysetpos){"number"===typeof d.bysetpos&&(d.bysetpos=[d.bysetpos]);
for(var l=0;l<d.bysetpos.length;l++){var k=d.bysetpos[l];if(0===k||!(-366<=k&&366>=k))throw Error("bysetpos must be between 1 and 366, or between -366 and -1");}}if(!(v(d.byweekno)||v(d.byyearday)||v(d.bymonthday)||null!==d.byweekday||null!==d.byeaster))switch(d.freq){case h.YEARLY:d.bymonth||(d.bymonth=d.dtstart.getMonth()+1);d.bymonthday=d.dtstart.getDate();break;case h.MONTHLY:d.bymonthday=d.dtstart.getDate();break;case h.WEEKLY:d.byweekday=p.getWeekday(d.dtstart)}null===d.bymonth||d.bymonth instanceof
Array||(d.bymonth=[d.bymonth]);null===d.byyearday||d.byyearday instanceof Array||(d.byyearday=[d.byyearday]);if(null===d.bymonthday)d.bymonthday=[],d.bynmonthday=[];else if(d.bymonthday instanceof Array){for(var m=[],w=[],l=0;l<d.bymonthday.length;l++)k=d.bymonthday[l],0<k?m.push(k):0>k&&w.push(k);d.bymonthday=m;d.bynmonthday=w}else 0>d.bymonthday?(d.bynmonthday=[d.bymonthday],d.bymonthday=[]):(d.bynmonthday=[],d.bymonthday=[d.bymonthday]);null===d.byweekno||d.byweekno instanceof Array||(d.byweekno=
[d.byweekno]);if(null===d.byweekday)d.bynweekday=null;else if("number"===typeof d.byweekday)d.byweekday=[d.byweekday],d.bynweekday=null;else if(d.byweekday instanceof D)!d.byweekday.n||d.freq>h.MONTHLY?(d.byweekday=[d.byweekday.weekday],d.bynweekday=null):(d.bynweekday=[[d.byweekday.weekday,d.byweekday.n]],d.byweekday=null);else{k=[];m=[];for(l=0;l<d.byweekday.length;l++)w=d.byweekday[l],"number"===typeof w?k.push(w):!w.n||d.freq>h.MONTHLY?k.push(w.weekday):m.push([w.weekday,w.n]);d.byweekday=v(k)?
k:null;d.bynweekday=v(m)?m:null}null===d.byhour?d.byhour=d.freq<h.HOURLY?[d.dtstart.getHours()]:null:"number"===typeof d.byhour&&(d.byhour=[d.byhour]);null===d.byminute?d.byminute=d.freq<h.MINUTELY?[d.dtstart.getMinutes()]:null:"number"===typeof d.byminute&&(d.byminute=[d.byminute]);null===d.bysecond?d.bysecond=d.freq<h.SECONDLY?[d.dtstart.getSeconds()]:null:"number"===typeof d.bysecond&&(d.bysecond=[d.bysecond]);if(d.freq>=h.HOURLY)this.timeset=null;else{this.timeset=[];for(l=0;l<d.byhour.length;l++)for(k=
d.byhour[l],m=0;m<d.byminute.length;m++)for(var w=d.byminute[m],n=0;n<d.bysecond.length;n++)this.timeset.push(new p.Time(k,w,d.bysecond[n],g));p.sort(this.timeset)}};h.FREQUENCIES="YEARLY MONTHLY WEEKLY DAILY HOURLY MINUTELY SECONDLY".split(" ");h.YEARLY=0;h.MONTHLY=1;h.WEEKLY=2;h.DAILY=3;h.HOURLY=4;h.MINUTELY=5;h.SECONDLY=6;h.MO=new D(0);h.TU=new D(1);h.WE=new D(2);h.TH=new D(3);h.FR=new D(4);h.SA=new D(5);h.SU=new D(6);h.DEFAULT_OPTIONS={freq:null,dtstart:null,interval:1,wkst:h.MO,count:null,until:null,
bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null};h.parseText=function(a,b){return C().parseText(a,b)};h.fromText=function(a,b){return C().fromText(a,b)};h.optionsToString=function(a){for(var b,c,e,f=[],d=Object.keys(a),g=Object.keys(h.DEFAULT_OPTIONS),l=0;l<d.length;l++)if(r(g,d[l])&&(b=d[l].toUpperCase(),c=a[d[l]],e=[],!(null===c||c instanceof Array&&!c.length))){switch(b){case "FREQ":c=
h.FREQUENCIES[a.freq];break;case "WKST":c=c.toString();break;case "BYWEEKDAY":b="BYDAY";c instanceof Array||(c=[c]);for(var k,m=0;m<c.length;m++)k=c[m],k instanceof D||(k=k instanceof Array?new D(k[0],k[1]):new D(k)),e[m]=k.toString();c=e;break;case "DTSTART":case "UNTIL":c=p.timeToUntilString(c);break;default:if(c instanceof Array){for(m=0;m<c.length;m++)e[m]=String(c[m]);c=e}else c=String(c)}f.push([b,c])}a=[];for(l=0;l<f.length;l++)b=f[l],a.push(b[0]+"\x3d"+b[1].toString());return a.join(";")};
h.prototype={constructor:h,all:function(a){if(a)return this._iter(new R("all",{},a));a=this._cacheGet("all");!1===a&&(a=this._iter(new H("all",{})),this._cacheAdd("all",a));return a},between:function(a,b,c,e){a={before:b,after:a,inc:c};if(e)return this._iter(new R("between",a,e));e=this._cacheGet("between",a);!1===e&&(e=this._iter(new H("between",a)),this._cacheAdd("between",e,a));return e},before:function(a,b){var c={dt:a,inc:b},e=this._cacheGet("before",c);!1===e&&(e=this._iter(new H("before",c)),
this._cacheAdd("before",e,c));return e},after:function(a,b){var c={dt:a,inc:b},e=this._cacheGet("after",c);!1===e&&(e=this._iter(new H("after",c)),this._cacheAdd("after",e,c));return e},count:function(){return this.all().length},toString:function(){return h.optionsToString(this.origOptions)},toText:function(a,b){return C().toText(this,a,b)},isFullyConvertibleToText:function(){return C().isFullyConvertible(this)},_cacheAdd:function(a,b,c){this._cache&&(b&&(b=b instanceof Date?p.clone(b):p.cloneDates(b)),
"all"===a?this._cache.all=b:(c._value=b,this._cache[a].push(c)))},_cacheGet:function(a,b){if(!this._cache)return!1;var c=!1,e=b?Object.keys(b):[];if("all"===a)c=this._cache.all;else for(var f,d=0;d<this._cache[a].length;d++){f=this._cache[a][d];var g;if(g=e.length)a:{g=void 0;for(var l=0;l<e.length;l++)if(g=e[l],String(b[g])!==String(f[g])){g=!0;break a}g=!1}if(!g){c=f._value;break}}if(!c&&this._cache.all){c=new H(a,b);for(d=0;d<this._cache.all.length&&c.accept(this._cache.all[d]);d++);c=c.getValue();
this._cacheAdd(a,c,b)}return c instanceof Array?p.cloneDates(c):c instanceof Date?p.clone(c):c},clone:function(){return new h(this.origOptions)},_iter:function(a){var b=this.options.dtstart,c=this.options.dtstart%1E3,e=b.getFullYear(),f=b.getMonth()+1,d=b.getDate(),g=b.getHours(),l=b.getMinutes(),k=b.getSeconds(),m=p.getWeekday(b),w=this.options.freq,n=this.options.interval,q=this.options.wkst,x=this.options.until,B=this.options.bymonth,D=this.options.byweekno,C=this.options.byyearday,E=this.options.byweekday,
G=this.options.byeaster,H=this.options.bymonthday,N=this.options.bynmonthday,Q=this.options.bysetpos,O=this.options.byhour,U=this.options.byminute,Z=this.options.bysecond,s=new I(this);s.rebuild(e,f);var J={};J[h.YEARLY]=s.ydayset;J[h.MONTHLY]=s.mdayset;J[h.WEEKLY]=s.wdayset;J[h.DAILY]=s.ddayset;J[h.HOURLY]=s.ddayset;J[h.MINUTELY]=s.ddayset;J[h.SECONDLY]=s.ddayset;var J=J[w],t;if(w<h.HOURLY)t=this.timeset;else{var L={};L[h.HOURLY]=s.htimeset;L[h.MINUTELY]=s.mtimeset;L[h.SECONDLY]=s.stimeset;L=L[w];
t=w>=h.HOURLY&&v(O)&&!r(O,g)||w>=h.MINUTELY&&v(U)&&!r(U,l)||w>=h.SECONDLY&&v(Z)&&!r(Z,l)?[]:L.call(s,g,l,k,c)}for(var c=0,V=this.options.count,z,y,P,u,A,M,W,$,aa;;){A=J.call(s,e,f,d);W=A[0];$=A[1];aa=A[2];u=!1;for(y=$;y<aa;y++)z=W[y],(u=v(B)&&!r(B,s.mmask[z])||v(D)&&!s.wnomask[z]||v(E)&&!r(E,s.wdaymask[z])||v(s.nwdaymask)&&!s.nwdaymask[z]||null!==G&&!r(s.eastermask,z)||(v(H)||v(N))&&!r(H,s.mdaymask[z])&&!r(N,s.nmdaymask[z])||v(C)&&(z<s.yearlen&&!r(C,z+1)&&!r(C,-s.yearlen+z)||z>=s.yearlen&&!r(C,z+
1-s.yearlen)&&!r(C,-s.nextyearlen+z-s.yearlen)))&&(W[z]=null);if(v(Q)&&v(t)){var X,Y=[];z;for(y=0;y<Q.length;y++){M=Q[y];0>M?(X=Math.floor(M/t.length),M=F(M,t.length)):(X=Math.floor((M-1)/t.length),M=F(M-1,t.length));try{A=[];for(P=$;P<aa;P++){var T=W[P];null!==T&&A.push(T)}z=0>X?A.slice(X)[0]:A[X];var R=t[M],ca=p.fromOrdinal(s.yearordinal+z),K=p.combine(ca,R);r(Y,K)||Y.push(K)}catch(ba){}}p.sort(Y);for(y=0;y<Y.length;y++){K=Y[y];if(x&&K>x)return this._len=c,a.getValue();if(K>=b){++c;if(!a.accept(K))return a.getValue();
if(V&&(--V,!V))return this._len=c,a.getValue()}}}else for(y=$;y<aa;y++)if(z=W[y],null!==z)for(ca=p.fromOrdinal(s.yearordinal+z),P=0;P<t.length;P++){R=t[P];K=p.combine(ca,R);if(x&&K>x)return this._len=c,a.getValue();if(K>=b){++c;if(!a.accept(K))return a.getValue();if(V&&(--V,!V))return this._len=c,a.getValue()}}y=!1;if(w===h.YEARLY){e+=n;if(e>p.MAXYEAR)return this._len=c,a.getValue();s.rebuild(e,f)}else if(w===h.MONTHLY){f+=n;if(12<f&&(u=Math.floor(f/12),f=A=F(f,12),e+=u,0===f&&(f=12,--e),e>p.MAXYEAR))return this._len=
c,a.getValue();s.rebuild(e,f)}else if(w===h.WEEKLY)d=q>m?d+(-(m+1+(6-q))+7*n):d+(-(m-q)+7*n),m=q,y=!0;else if(w===h.DAILY)d+=n,y=!0;else if(w===h.HOURLY){for(u&&(g+=Math.floor((23-g)/n)*n);g+=n,t=S(g,24),u=t.div,A=t.mod,u&&(g=A,d+=u,y=!0),v(O)&&!r(O,g););t=L.call(s,g,l,k)}else if(w===h.MINUTELY){for(u&&(l+=Math.floor((1439-(60*g+l))/n)*n);l+=n,t=S(l,60),u=t.div,A=t.mod,u&&(l=A,g+=u,t=S(g,24),u=t.div,A=t.mod,u&&(g=A,d+=u,y=!0)),v(O)&&!r(O,g)||v(U)&&!r(U,l););t=L.call(s,g,l,k)}else if(w===h.SECONDLY){for(u&&
(k+=Math.floor((86399-(3600*g+60*l+k))/n)*n);k+=n,t=S(k,60),u=t.div,A=t.mod,u&&(k=A,l+=u,t=S(l,60),u=t.div,A=t.mod,u&&(l=A,g+=u,t=S(g,24),u=t.div,A=t.mod,u&&(g=A,d+=u,y=!0))),v(O)&&!r(O,g)||v(U)&&!r(U,l)||v(Z)&&!r(Z,k););t=L.call(s,g,l,k)}if(y&&28<d&&(u=p.monthRange(e,f-1)[1],d>u)){for(;d>u;){d-=u;++f;if(13===f&&(f=1,++e,e>p.MAXYEAR))return this._len=c,a.getValue();u=p.monthRange(e,f-1)[1]}s.rebuild(e,f)}}}};h.parseString=function(a){a=a.replace(/^\s+|\s+$/,"");if(!a.length)return null;var b,c,e,
f=a.split(";"),d={};for(a=0;a<f.length;a++)switch(b=f[a].split("\x3d"),c=b[0],e=b[1],c){case "FREQ":d.freq=h[e];break;case "WKST":d.wkst=h[e];break;case "COUNT":case "INTERVAL":case "BYSETPOS":case "BYMONTH":case "BYMONTHDAY":case "BYYEARDAY":case "BYWEEKNO":case "BYHOUR":case "BYMINUTE":case "BYSECOND":if(-1!==e.indexOf(","))for(e=e.split(","),b=0;b<e.length;b++)/^[+-]?\d+$/.test(e[b])&&(e[b]=Number(e[b]));else/^[+-]?\d+$/.test(e)&&(e=Number(e));c=c.toLowerCase();d[c]=e;break;case "BYDAY":var g;
e=e.split(",");d.byweekday=[];for(b=0;b<e.length;b++)g=e[b],2===g.length?(g=h[g],d.byweekday.push(g)):(g=g.match(/^([+-]?\d)([A-Z]{2})$/),c=Number(g[1]),g=g[2],g=h[g].weekday,d.byweekday.push(new D(g,c)));break;case "DTSTART":d.dtstart=p.untilStringToDate(e);break;case "UNTIL":d.until=p.untilStringToDate(e);break;case "BYEASTER":d.byeaster=Number(e);break;default:throw Error("Unknown RRULE property '"+c+"'");}return d};h.fromString=function(a){return new h(h.parseString(a))};var I=function(a){this.rrule=
a;this.eastermask=this.nwdaymask=this.wnomask=this.wdaymask=this.nmdaymask=this.mdaymask=this.mrange=this.mmask=this.yearweekday=this.yearordinal=this.nextyearlen=this.yearlen=this.lastmonth=this.lastyear=null};I.prototype.easter=function(a,b){var c=a%19,e=Math.floor(a/100),f=a%100,d=Math.floor(19*c+e-Math.floor(e/4)-Math.floor((e-Math.floor((e+8)/25)+1)/3)+15)%30,e=Math.floor(32+e%4*2+2*Math.floor(f/4)-d-f%4)%7,c=Math.floor((c+11*d+22*e)/451),d=Date.UTC(a,Math.floor((d+e-7*c+114)/31)-1,(d+e-7*c+
114)%31+1+(b||0)),c=Date.UTC(a,0,1);return[Math.ceil((d-c)/864E5)]};I.prototype.rebuild=function(a,b){var c=this.rrule;if(a!==this.lastyear){this.yearlen=p.isLeapYear(a)?366:365;this.nextyearlen=p.isLeapYear(a+1)?366:365;var e=new Date(a,0,1);this.yearordinal=p.toOrdinal(e);this.yearweekday=p.getWeekday(e);var f=p.getWeekday(new Date(a,0,1));365===this.yearlen?(this.mmask=[].concat(ea),this.mdaymask=[].concat(ha),this.nmdaymask=[].concat(ja),this.wdaymask=ba.slice(f),this.mrange=[].concat(la)):(this.mmask=
[].concat(fa),this.mdaymask=[].concat(ga),this.nmdaymask=[].concat(ia),this.wdaymask=ba.slice(f),this.mrange=[].concat(ka));if(v(c.options.byweekno)){this.wnomask=q(0,this.yearlen+7);var d,g,e=d=F(7-this.yearweekday+c.options.wkst,7);4<=e?(e=0,g=this.yearlen+F(this.yearweekday-c.options.wkst,7)):g=this.yearlen-e;var l=Math.floor(g/7);g=F(g,7);for(var f=Math.floor(l+g/4),k,l=0;l<c.options.byweekno.length;l++)if(k=c.options.byweekno[l],0>k&&(k+=f+1),0<k&&k<=f)for(1<k?(k=e+7*(k-1),e!==d&&(k-=7-d)):k=
e,g=0;7>g&&(this.wnomask[k]=1,k++,this.wdaymask[k]!==c.options.wkst);g++);if(r(c.options.byweekno,1)&&(k=e+7*f,e!==d&&(k-=7-d),k<this.yearlen))for(l=0;7>l&&(this.wnomask[k]=1,k+=1,this.wdaymask[k]!==c.options.wkst);l++);if(e&&(r(c.options.byweekno,-1)?l=-1:(l=p.getWeekday(new Date(a-1,0,1)),g=F(7-l+c.options.wkst,7),d=p.isLeapYear(a-1)?366:365,l=4<=g?Math.floor(52+F(d+F(l-c.options.wkst,7),7)/4):Math.floor(52+F(this.yearlen-e,7)/4)),r(c.options.byweekno,l)))for(k=0;k<e;k++)this.wnomask[k]=1}else this.wnomask=
null}if(v(c.options.bynweekday)&&(b!==this.lastmonth||a!==this.lastyear)){e=[];if(c.options.freq===h.YEARLY)if(v(c.options.bymonth))for(l=0;l<c.options.bymonth.length;l++)b=c.options.bymonth[l],e.push(this.mrange.slice(b-1,b+1));else e=[[0,this.yearlen]];else c.options.freq===h.MONTHLY&&(e=[this.mrange.slice(b-1,b+1)]);if(v(e))for(this.nwdaymask=q(0,this.yearlen),l=0;l<e.length;l++){g=e[l];d=g[0];var m=g[1];--m;for(g=0;g<c.options.bynweekday.length;g++)f=c.options.bynweekday[g][0],k=c.options.bynweekday[g][1],
0>k?(k=m+7*(k+1),k-=F(this.wdaymask[k]-f,7)):(k=d+7*(k-1),k+=F(7-this.wdaymask[k]+f,7)),d<=k&&k<=m&&(this.nwdaymask[k]=1)}this.lastyear=a;this.lastmonth=b}null!==c.options.byeaster&&(this.eastermask=this.easter(a,c.options.byeaster))};I.prototype.ydayset=function(a,b,c){return[G(this.yearlen),0,this.yearlen]};I.prototype.mdayset=function(a,b,c){a=q(null,this.yearlen);c=this.mrange[b-1];b=this.mrange[b];for(var e=c;e<b;e++)a[e]=e;return[a,c,b]};I.prototype.wdayset=function(a,b,c){var e=q(null,this.yearlen+
7);b=a=p.toOrdinal(new Date(a,b-1,c))-this.yearordinal;for(c=0;7>c&&(e[a]=a,++a,this.wdaymask[a]!==this.rrule.options.wkst);c++);return[e,b,a]};I.prototype.ddayset=function(a,b,c){var e=q(null,this.yearlen);a=p.toOrdinal(new Date(a,b-1,c))-this.yearordinal;e[a]=a;return[e,a,a+1]};I.prototype.htimeset=function(a,b,c,e){for(var f=[],d=this.rrule,g=0;g<d.options.byminute.length;g++){b=d.options.byminute[g];for(var l=0;l<d.options.bysecond.length;l++)c=d.options.bysecond[l],f.push(new p.Time(a,b,c,e))}p.sort(f);
return f};I.prototype.mtimeset=function(a,b,c,e){for(var f=[],d=this.rrule,g=0;g<d.options.bysecond.length;g++)c=d.options.bysecond[g],f.push(new p.Time(a,b,c,e));p.sort(f);return f};I.prototype.stimeset=function(a,b,c,e){return[new p.Time(a,b,c,e)]};var H=function(a,b){this.init(a,b)};H.prototype={constructor:H,init:function(a,b){this.method=a;this.args=b;this.maxDate=this.minDate=null;this._result=[];"between"===a?(this.maxDate=b.inc?b.before:new Date(b.before.getTime()-1),this.minDate=b.inc?b.after:
new Date(b.after.getTime()+1)):"before"===a?this.maxDate=b.inc?b.dt:new Date(b.dt.getTime()-1):"after"===a&&(this.minDate=b.inc?b.dt:new Date(b.dt.getTime()+1))},accept:function(a){var b=this.minDate&&a<this.minDate,c=this.maxDate&&a>this.maxDate;if("between"===this.method){if(b)return!0;if(c)return!1}else if("before"===this.method){if(c)return!1}else if("after"===this.method){if(b)return!0;this.add(a);return!1}return this.add(a)},add:function(a){this._result.push(a);return!0},getValue:function(){var a=
this._result;switch(this.method){case "all":case "between":return a;case "before":case "after":return a.length?a[a.length-1]:null}},clone:function(){return new H(this.method,this.args)}};var R=function(a,b,c){if(!r(["all","between"],a))throw Error('Invalid method "'+a+'". Only all and between works with iterator.');this.add=function(a){return c(a,this._result.length)?(this._result.push(a),!0):!1};this.init(a,b)};R.prototype=H.prototype;var N=function(a){this._cache=a?null:{all:!1,before:[],after:[],
between:[]};this._rrule=[];this._rdate=[];this._exrule=[];this._exdate=[]};N.prototype={constructor:N,rrule:function(a){if(!(a instanceof h))throw new TypeError(String(a)+" is not RRule instance");r(this._rrule.map(String),String(a))||this._rrule.push(a)},rdate:function(a){if(!(a instanceof Date))throw new TypeError(String(a)+" is not Date instance");r(this._rdate.map(Number),Number(a))||(this._rdate.push(a),p.sort(this._rdate))},exrule:function(a){if(!(a instanceof h))throw new TypeError(String(a)+
" is not RRule instance");r(this._exrule.map(String),String(a))||this._exrule.push(a)},exdate:function(a){if(!(a instanceof Date))throw new TypeError(String(a)+" is not Date instance");r(this._exdate.map(Number),Number(a))||(this._exdate.push(a),p.sort(this._exdate))},valueOf:function(){var a=[];this._rrule.length&&this._rrule.forEach(function(b){a.push("RRULE:"+b)});this._rdate.length&&a.push("RDATE:"+this._rdate.map(function(a){return p.timeToUntilString(a)}).join(","));this._exrule.length&&this._exrule.forEach(function(b){a.push("EXRULE:"+
b)});this._exdate.length&&a.push("EXDATE:"+this._exdate.map(function(a){return p.timeToUntilString(a)}).join(","));return a},toString:function(){return JSON.stringify(this.valueOf())},_iter:function(a){function b(a,b){e.forEach(function(d){d.between(a,b,!0).forEach(function(a){c[Number(a)]=!0})})}var c={},e=this._exrule,f=a.accept;this._exdate.forEach(function(a){c[Number(a)]=!0});a.accept=function(a){var d=Number(a);return c[d]||(b(new Date(d-1),new Date(d+1)),c[d])?!0:(c[d]=!0,f.call(this,a))};
"between"===a.method&&(b(a.args.after,a.args.before),a.accept=function(a){var b=Number(a);return c[b]?!0:(c[b]=!0,f.call(this,a))});for(var d=0;d<this._rdate.length&&a.accept(new Date(this._rdate[d]));d++);this._rrule.forEach(function(b){b._iter(a)});d=a._result;p.sort(d);switch(a.method){case "all":case "between":return d;case "before":return d.length&&d[d.length-1]||null;case "after":return d.length&&d[0]||null;default:return null}},clone:function(){var a=new N(!!this._cache),b;for(b=0;b<this._rrule.length;b++)a.rrule(this._rrule[b].clone());
for(b=0;b<this._rdate.length;b++)a.rdate(new Date(this._rdate[b]));for(b=0;b<this._exrule.length;b++)a.exrule(this._exrule[b].clone());for(b=0;b<this._exdate.length;b++)a.exdate(new Date(this._exdate[b]));return a}};"all between before after count _cacheAdd _cacheGet".split(" ").forEach(function(a){N.prototype[a]=h.prototype[a]});var x=function(){};x.DEFAULT_OPTIONS={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,ignoretz:!1,tzinfos:null};x._freq_map={YEARLY:h.YEARLY,MONTHLY:h.MONTHLY,
WEEKLY:h.WEEKLY,DAILY:h.DAILY,HOURLY:h.HOURLY,MINUTELY:h.MINUTELY,SECONDLY:h.SECONDLY};x._weekday_map={MO:0,TU:1,WE:2,TH:3,FR:4,SA:5,SU:6};x.prototype={constructor:x,_handle_int:function(a,b,c,e){a[b.toLowerCase()]=parseInt(c,10)},_handle_int_list:function(a,b,c,e){a[b.toLowerCase()]=c.split(",").map(function(a){return parseInt(a,10)})},_handle_FREQ:function(a,b,c,e){a.freq=x._freq_map[c]},_handle_UNTIL:function(a,b,c,e){try{a.until=p.untilStringToDate(c)}catch(f){throw Error("invalid until date");
}},_handle_WKST:function(a,b,c,e){a.wkst=x._weekday_map[c]},_handle_BYWEEKDAY:function(a,b,c,e){var f,d,g;b=[];e=c.split(",");for(c=0;c<e.length;c++){g=e[c];if(-1<g.indexOf("("))f=g.split("("),d=f[0],f=parseInt(f.slice(1,-1),10);else{for(d=0;d<g.length&&-1!=="+-0123456789".indexOf(g[d]);d++);f=g.slice(0,d)||null;d=g.slice(d);f&&(f=parseInt(f,10))}f=new D(x._weekday_map[d],f);b.push(f)}a.byweekday=b},_parseRfcRRule:function(a,b){b=b||{};b.dtstart=b.dtstart||null;b.cache=b.cache||!1;b.ignoretz=b.ignoretz||
!1;b.tzinfos=b.tzinfos||null;var c,e;if(-1!==a.indexOf(":")){if(e=a.split(":"),c=e[0],e=e[1],"RRULE"!==c)throw Error("unknown parameter name");}else e=a;var f,d={},g=e.split(";");for(f=0;f<g.length;f++){e=g[f].split("\x3d");c=e[0].toUpperCase();e=e[1].toUpperCase();try{this["_handle_"+c](d,c,e,{ignoretz:b.ignoretz,tzinfos:b.tzinfos})}catch(l){throw Error("unknown parameter '"+c+"':"+e);}}d.dtstart=d.dtstart||b.dtstart;return new h(d,!b.cache)},_parseRfc:function(a,b){b.compatible&&(b.forceset=!0,
b.unfold=!0);a=a&&a.toUpperCase().trim();if(!a)throw Error("Invalid empty string");var c=0,e,f;if(b.unfold)for(f=a.split("\n");c<f.length;)(e=f[c]=f[c].replace(/\s+$/g,""))?0<c&&" "===e[0]?(f[c-1]+=e.slice(1),f.splice(c,1)):c+=1:f.splice(c,1);else f=a.split(/\s/);var d=[],g=[],h=[],k=[],m,n,q,r;if(b.forceset||1!==f.length||-1!==a.indexOf(":")&&0!==a.indexOf("RRULE:")){for(c=0;c<f.length;c++)if(e=f[c]){-1===e.indexOf(":")?m="RRULE":(m=e.split(":"),e=m.slice(0,1).concat([m.slice(1).join(":")]),m=e[0],
e=e[1]);n=m.split(";");if(!n)throw Error("empty property name");m=n[0];n=n.slice(1);if("RRULE"===m){for(m=0;m<n.length;)throw q=n[m],Error("unsupported RRULE parm: "+q);d.push(e)}else if("RDATE"===m){for(m=0;m<n.length;m++)if(q=n[m],"VALUE\x3dDATE-TIME"!==q)throw Error("unsupported RDATE parm: "+q);g.push(e)}else if("EXRULE"===m){for(m=0;m<n.length;)throw q=n[m],Error("unsupported EXRULE parm: "+q);h.push(e)}else if("EXDATE"===m){for(m=0;m<n.length;m++)if(q=n[m],"VALUE\x3dDATE-TIME"!==q)throw Error("unsupported RDATE parm: "+
q);k.push(e)}else if("DTSTART"===m)r=p.untilStringToDate(e);else throw Error("unsupported property: "+m);}if(b.forceset||1<d.length||g.length||h.length||k.length){c=new N(!b.cache);for(m=0;m<d.length;m++)c.rrule(this._parseRfcRRule(d[m],{dtstart:b.dtstart||r,ignoretz:b.ignoretz,tzinfos:b.tzinfos}));for(m=0;m<g.length;m++)for(f=g[m].split(","),d=0;d<f.length;d++)e=f[d],c.rdate(p.untilStringToDate(e));for(m=0;m<h.length;m++)c.exrule(this._parseRfcRRule(h[m],{dtstart:b.dtstart||r,ignoretz:b.ignoretz,
tzinfos:b.tzinfos}));for(m=0;m<k.length;m++)for(f=k[m].split(","),d=0;d<f.length;d++)e=f[d],c.exdate(p.untilStringToDate(e));b.campatiable&&b.dtstart&&c.rdate(r);return c}return this._parseRfcRRule(d[0],{dtstart:b.dtstart||r,cache:b.cache,ignoretz:b.ignoretz,tzinfos:b.tzinfos})}return this._parseRfcRRule(f[0],{cache:b.cache,dtstart:b.dtstart,ignoretz:b.ignoretz,tzinfos:b.tzinfos})},parse:function(a,b){b=b||{};var c=[],e=Object.keys(b),f=Object.keys(x.DEFAULT_OPTIONS);e.forEach(function(a){r(f,a)||
c.push(a)},this);if(c.length)throw Error("Invalid options: "+c.join(", "));f.forEach(function(a){r(e,a)||(b[a]=x.DEFAULT_OPTIONS[a])});return this._parseRfc(a,b)}};x.prototype._handle_DTSTART=function(a,b,c,e){a[b.toLowerCase()]=p.untilStringToDate(c)};x.prototype._handle_BYDAY=x.prototype._handle_BYWEEKDAY;x.prototype._handle_INTERVAL=x.prototype._handle_int;x.prototype._handle_COUNT=x.prototype._handle_int;"_handle_BYSETPOS _handle_BYMONTH _handle_BYMONTHDAY _handle_BYYEARDAY _handle_BYEASTER _handle_BYWEEKNO _handle_BYHOUR _handle_BYMINUTE _handle_BYSECOND".split(" ").forEach(function(a){x.prototype[a]=
x.prototype._handle_int_list});var da=new x;h.RRule=h;h.RRuleSet=N;h.rrulestr=function(){return da.parse.apply(da,arguments)};return h});